{% extends 'base.html' %}
{% load static %}

{% block title %}Scan Computer - Asset Management{% endblock %}

{% block content %}
<div style="max-width: 600px; margin: 0 auto;">
  <!-- Scanner Card -->
  <div class="scanner-card">
    <div class="scanner-header">
      <div style="display: flex; align-items: center; gap: var(--space-3);">
        <i class="bi bi-upc-scan" style="font-size: 1.5rem;"></i>
        <div>
          <h1 style="font-size: 1.25rem; margin: 0; color: white;">Computer Scanner</h1>
          <p style="font-size: 0.75rem; opacity: 0.9; margin: 0;">Position barcode within the frame</p>
        </div>
      </div>
    </div>

    <!-- Scanner Viewport -->
    <div class="scanner-viewport" id="interactive">
      <video autoplay="true" preload="auto" muted="true" playsinline="true" id="scannerVideo"></video>
      <canvas class="drawingBuffer" id="scannerCanvas"></canvas>

      <!-- Scanner Overlay -->
      <div class="scanner-overlay">
        <div class="scanner-frame" id="scannerFrame">
          <div class="scanner-corners"></div>
        </div>
      </div>

      <!-- Scanning Indicator -->
      <div id="scanningIndicator" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.75rem; display: none;">
        <i class="bi bi-wifi" style="animation: pulse 1s infinite;"></i> Scanning...
      </div>
    </div>

    <!-- Scanner Controls -->
    <div class="scanner-controls">
      <button class="btn btn-primary" id="startBtn" onclick="startScanning()">
        <i class="bi bi-play-fill"></i>
        Start Scanning
      </button>
      <button class="btn btn-secondary" id="stopBtn" onclick="stopScanning()" style="display: none;">
        <i class="bi bi-stop-fill"></i>
        Stop
      </button>
      <a href="{% url 'add_computer' %}" class="btn btn-outline">
        <i class="bi bi-keyboard"></i>
        Manual Entry
      </a>
    </div>
  </div>

  <!-- Instructions Card -->
  <div class="card" style="margin-top: var(--space-6);">
    <div class="card-header">
      <h3 class="card-title">
        <i class="bi bi-info-circle" style="color: var(--primary); margin-right: var(--space-2);"></i>
        How to Scan
      </h3>
    </div>
    <div class="card-body">
      <div style="display: flex; flex-direction: column; gap: var(--space-4);">
        <div style="display: flex; align-items: flex-start; gap: var(--space-3);">
          <div style="width: 32px; height: 32px; border-radius: var(--radius-full); background: var(--primary-light); background: rgba(99, 102, 241, 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: 600;">1</div>
          <div>
            <p style="font-weight: 600; margin-bottom: 2px;">Click "Start Scanning"</p>
            <p style="font-size: 0.875rem; color: var(--gray-500);">Allow camera access when prompted</p>
          </div>
        </div>
        <div style="display: flex; align-items: flex-start; gap: var(--space-3);">
          <div style="width: 32px; height: 32px; border-radius: var(--radius-full); background: var(--primary-light); background: rgba(99, 102, 241, 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: 600;">2</div>
          <div>
            <p style="font-weight: 600; margin-bottom: 2px;">Position the Barcode</p>
            <p style="font-size: 0.875rem; color: var(--gray-500);">Align the barcode within the scanning frame</p>
          </div>
        </div>
        <div style="display: flex; align-items: flex-start; gap: var(--space-3);">
          <div style="width: 32px; height: 32px; border-radius: var(--radius-full); background: var(--primary-light); background: rgba(99, 102, 241, 0.1); color: var(--primary); display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: 600;">3</div>
          <div>
            <p style="font-weight: 600; margin-bottom: 2px;">Auto-Detection</p>
            <p style="font-size: 0.875rem; color: var(--gray-500);">The scanner will automatically detect and process the barcode</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Supported Barcodes -->
  <div class="card" style="margin-top: var(--space-4);">
    <div class="card-body">
      <p style="font-size: 0.75rem; color: var(--gray-500); text-align: center;">
        <i class="bi bi-check-circle" style="color: var(--success);"></i>
        Supports Code 128, EAN-13, EAN-8, UPC-A, UPC-E, Code 39, Code 93, and Codabar
      </p>
    </div>
  </div>
</div>

<!-- Audio for beep sound -->
<audio id="beep" style="display:none;">
  <source src="{% static 'beep.mp3' %}" type="audio/mpeg">
</audio>

<style>
  .scanner-card {
    background: var(--bg-primary);
    border-radius: var(--radius-xl);
    overflow: hidden;
    box-shadow: var(--shadow-lg);
  }

  .scanner-header {
    padding: var(--space-5);
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
  }

  .scanner-viewport {
    position: relative;
    background: #000;
    aspect-ratio: 4/3;
    overflow: hidden;
  }

  .scanner-viewport video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .scanner-viewport canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  .scanner-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
  }

  .scanner-frame {
    width: 80%;
    max-width: 300px;
    height: 120px;
    border: 3px solid rgba(255, 255, 255, 0.5);
    border-radius: var(--radius);
    position: relative;
    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.4);
  }

  .scanner-frame::before {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    top: 50%;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--error), transparent);
    animation: scan 2s ease-in-out infinite;
  }

  .scanner-frame.detected {
    border-color: var(--success);
  }

  .scanner-frame.detected::before {
    background: linear-gradient(90deg, transparent, var(--success), transparent);
    animation: none;
  }

  @keyframes scan {
    0%, 100% { transform: translateY(-30px); opacity: 0.5; }
    50% { transform: translateY(30px); opacity: 1; }
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .scanner-corners::before,
  .scanner-corners::after {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    border-color: white;
    border-style: solid;
  }

  .scanner-frame::after {
    content: '';
    position: absolute;
    bottom: -3px;
    right: -3px;
    width: 20px;
    height: 20px;
    border-right: 3px solid white;
    border-bottom: 3px solid white;
  }

  .scanner-corners::before {
    top: -3px;
    left: -3px;
    border-width: 3px 0 0 3px;
  }

  .scanner-corners::after {
    top: -3px;
    right: -3px;
    border-width: 3px 3px 0 0;
  }

  .scanner-controls {
    padding: var(--space-5);
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-3);
    justify-content: center;
    background: var(--gray-50);
  }

  /* Mobile optimizations */
  @media (max-width: 480px) {
    .scanner-viewport {
      aspect-ratio: 1/1;
    }

    .scanner-frame {
      width: 85%;
      height: 100px;
    }

    .scanner-controls {
      flex-direction: column;
    }

    .scanner-controls .btn {
      width: 100%;
    }
  }
</style>

<script src="{% static 'js/quagga.min.js' %}"></script>
<script>
  const beep = document.getElementById('beep');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const scannerFrame = document.getElementById('scannerFrame');
  const scanningIndicator = document.getElementById('scanningIndicator');

  let isScanning = false;

  // Improved detection state - sliding window with confidence
  const detectionState = {
    results: [],           // Sliding window of recent results
    maxResults: 10,        // Keep only last 10 results (faster detection)
    requiredMatches: 5,    // Need 5 consistent reads
    confidenceThreshold: 0.15,  // Max error rate (lower = more confident)
    lastDetectedCode: null,
    processingDetection: false
  };

  function resetDetectionState() {
    detectionState.results = [];
    detectionState.lastDetectedCode = null;
    detectionState.processingDetection = false;
  }

  // Get the most frequent code that meets confidence requirements
  function getBestMatch() {
    const validResults = detectionState.results;
    if (validResults.length < detectionState.requiredMatches) return null;

    // Count occurrences
    const counts = {};
    validResults.forEach(r => {
      counts[r.code] = (counts[r.code] || 0) + 1;
    });

    // Find the code with most occurrences
    let bestCode = null;
    let maxCount = 0;
    for (const code in counts) {
      if (counts[code] > maxCount) {
        maxCount = counts[code];
        bestCode = code;
      }
    }

    // Require at least requiredMatches consistent reads
    if (maxCount >= detectionState.requiredMatches) {
      return bestCode;
    }
    return null;
  }

  function load_quagga() {
    if ($('#interactive').length > 0 && navigator.mediaDevices && typeof navigator.mediaDevices.getUserMedia === 'function') {

      resetDetectionState();

      if (Quagga.initialized == undefined) {
        Quagga.onDetected(function(result) {
          if (detectionState.processingDetection) return;

          const code = result.codeResult.code;
          const error = result.codeResult.error;

          // Only accept high-confidence results (error is 0-1, lower is better)
          if (error !== undefined && error > detectionState.confidenceThreshold) {
            return; // Skip low-confidence detections
          }

          // Add to sliding window
          detectionState.results.push({ code: code, error: error || 0 });

          // Keep only recent results (sliding window)
          if (detectionState.results.length > detectionState.maxResults) {
            detectionState.results.shift();
          }

          // Check for consistent match
          const bestMatch = getBestMatch();
          if (bestMatch && bestMatch !== detectionState.lastDetectedCode) {
            detectionState.processingDetection = true;
            detectionState.lastDetectedCode = bestMatch;

            scannerFrame.classList.add('detected');
            beep.play();
            Quagga.stop();
            isScanning = false;
            saveBarcode(bestMatch);
          }
        });
      }

      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          constraints: {
            width: { min: 640, ideal: 1280, max: 1920 },
            height: { min: 480, ideal: 720, max: 1080 },
            facingMode: "environment",
            aspectRatio: { min: 1, max: 2 }
          },
          target: document.querySelector('#interactive'),
          area: { // Focus on center 80% of the frame for faster processing
            top: "10%",
            right: "10%",
            left: "10%",
            bottom: "10%"
          }
        },
        decoder: {
          readers: [
            "code_128_reader",
            "ean_reader",
            "ean_8_reader",
            "code_39_reader",
            "code_93_reader",
            "upc_reader",
            "upc_e_reader",
            "codabar_reader"
          ],
          multiple: false  // Only detect one barcode at a time
        },
        locator: {
          halfSample: false,  // Full resolution for better accuracy
          patchSize: 'large', // Larger patches = faster but may miss small barcodes
        },
        locate: true,
        frequency: 10  // Process 10 frames per second (reduces CPU usage)
      }, function(err) {
        if (err) {
          console.error(err);
          alert('Error initializing camera. Please ensure camera permissions are granted.');
          return;
        }
        console.log("Scanner initialized");
        Quagga.start();
        isScanning = true;
        updateUI();
      });
    }
  }

  Quagga.onProcessed(function(result) {
    const drawingCtx = Quagga.canvas.ctx.overlay;
    const drawingCanvas = Quagga.canvas.dom.overlay;

    if (result) {
      if (result.boxes) {
        drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
        result.boxes.filter(box => box !== result.box).forEach(box => {
          Quagga.ImageDebug.drawPath(box, { x: 0, y: 1 }, drawingCtx, { color: "rgba(99, 102, 241, 0.5)", lineWidth: 2 });
        });
      }

      if (result.box) {
        Quagga.ImageDebug.drawPath(result.box, { x: 0, y: 1 }, drawingCtx, { color: "#6366f1", lineWidth: 2 });
      }

      if (result.codeResult && result.codeResult.code) {
        Quagga.ImageDebug.drawPath(result.line, { x: 'x', y: 'y' }, drawingCtx, { color: '#10b981', lineWidth: 3 });
      }
    }
  });

  function startScanning() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      alert('Camera access is not supported in this browser. Please use a modern browser.');
      return;
    }
    scannerFrame.classList.remove('detected');
    resetDetectionState();
    load_quagga();
  }

  function stopScanning() {
    Quagga.stop();
    isScanning = false;
    resetDetectionState();
    updateUI();
  }

  function updateUI() {
    if (isScanning) {
      startBtn.style.display = 'none';
      stopBtn.style.display = 'inline-flex';
      scanningIndicator.style.display = 'block';
    } else {
      startBtn.style.display = 'inline-flex';
      stopBtn.style.display = 'none';
      scanningIndicator.style.display = 'none';
    }
  }

  function saveBarcode(barcode_data) {
    // Show loading state
    scanningIndicator.innerHTML = '<i class="bi bi-check-circle"></i> Barcode detected: ' + barcode_data;

    $.ajax({
      url: '{% url "save_barcode" %}',
      timeout: 10000,
      method: 'POST',
      data: {
        barcode_data: barcode_data,
        csrfmiddlewaretoken: '{{ csrf_token }}',
      },
      success: function(response) {
        console.log('Saved barcode:', barcode_data);
        // Redirect to the form page
        window.location.href = '{% url "computer_form" barcode=0 %}'.replace('0', barcode_data);
      },
      error: function(response) {
        console.error('Error saving barcode:', barcode_data);
        alert('Error processing barcode. Redirecting to form...');
        window.location.href = '{% url "computer_form" barcode=0 %}'.replace('0', barcode_data);
      },
    });
  }

  // Initialize UI
  updateUI();
</script>
{% endblock %}
