{% extends 'base.html' %}
{% load static %}

{% block title %}Scan Docking Station - Asset Management{% endblock %}

{% block content %}
<div style="max-width: 600px; margin: 0 auto;">
  <div class="scanner-card">
    <div class="scanner-header">
      <div style="display: flex; align-items: center; gap: var(--space-3);">
        <i class="bi bi-hdd-network" style="font-size: 1.5rem;"></i>
        <div>
          <h1 style="font-size: 1.25rem; margin: 0; color: white;">Docking Station Scanner</h1>
          <p style="font-size: 0.75rem; opacity: 0.9; margin: 0;">Position barcode within the frame</p>
        </div>
      </div>
    </div>

    <div class="scanner-viewport" id="interactive">
      <video autoplay="true" preload="auto" muted="true" playsinline="true"></video>
      <canvas class="drawingBuffer"></canvas>
      <div class="scanner-overlay">
        <div class="scanner-frame" id="scannerFrame">
          <div class="scanner-corners"></div>
        </div>
      </div>
      <div id="scanningIndicator" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.75rem; display: none;">
        <i class="bi bi-wifi" style="animation: pulse 1s infinite;"></i> Scanning...
      </div>
    </div>

    <div class="scanner-controls">
      <button class="btn btn-primary" id="startBtn" onclick="startScanning()">
        <i class="bi bi-play-fill"></i> Start Scanning
      </button>
      <button class="btn btn-secondary" id="stopBtn" onclick="stopScanning()" style="display: none;">
        <i class="bi bi-stop-fill"></i> Stop
      </button>
      <a href="{% url 'add_dockingstation' %}" class="btn btn-outline">
        <i class="bi bi-keyboard"></i> Manual Entry
      </a>
    </div>
  </div>
</div>

<audio id="beep" style="display:none;">
  <source src="{% static 'beep.mp3' %}" type="audio/mpeg">
</audio>

<style>
  .scanner-card { background: var(--bg-primary); border-radius: var(--radius-xl); overflow: hidden; box-shadow: var(--shadow-lg); }
  .scanner-header { padding: var(--space-5); background: linear-gradient(135deg, var(--success), #059669); color: white; }
  .scanner-viewport { position: relative; background: #000; aspect-ratio: 4/3; overflow: hidden; }
  .scanner-viewport video { width: 100%; height: 100%; object-fit: cover; }
  .scanner-viewport canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
  .scanner-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; }
  .scanner-frame { width: 80%; max-width: 300px; height: 120px; border: 3px solid rgba(255,255,255,0.5); border-radius: var(--radius); position: relative; box-shadow: 0 0 0 9999px rgba(0,0,0,0.4); }
  .scanner-frame::before { content: ''; position: absolute; left: 0; right: 0; top: 50%; height: 2px; background: linear-gradient(90deg, transparent, var(--error), transparent); animation: scan 2s ease-in-out infinite; }
  .scanner-frame.detected { border-color: var(--success); }
  @keyframes scan { 0%, 100% { transform: translateY(-30px); opacity: 0.5; } 50% { transform: translateY(30px); opacity: 1; } }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  .scanner-controls { padding: var(--space-5); display: flex; flex-wrap: wrap; gap: var(--space-3); justify-content: center; background: var(--gray-50); }
  @media (max-width: 480px) { .scanner-viewport { aspect-ratio: 1/1; } .scanner-controls { flex-direction: column; } .scanner-controls .btn { width: 100%; } }
</style>

<script src="{% static 'js/quagga.min.js' %}"></script>
<script>
  const beep = document.getElementById('beep');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const scannerFrame = document.getElementById('scannerFrame');
  const scanningIndicator = document.getElementById('scanningIndicator');
  let isScanning = false;

  // Improved detection state - sliding window with confidence
  const detectionState = {
    results: [],
    maxResults: 10,
    requiredMatches: 5,
    confidenceThreshold: 0.15,
    lastDetectedCode: null,
    processingDetection: false
  };

  function resetDetectionState() {
    detectionState.results = [];
    detectionState.lastDetectedCode = null;
    detectionState.processingDetection = false;
  }

  function getBestMatch() {
    const validResults = detectionState.results;
    if (validResults.length < detectionState.requiredMatches) return null;
    const counts = {};
    validResults.forEach(r => counts[r.code] = (counts[r.code] || 0) + 1);
    let bestCode = null, maxCount = 0;
    for (const code in counts) {
      if (counts[code] > maxCount) { maxCount = counts[code]; bestCode = code; }
    }
    return maxCount >= detectionState.requiredMatches ? bestCode : null;
  }

  function load_quagga() {
    if ($('#interactive').length > 0 && navigator.mediaDevices) {
      resetDetectionState();
      if (Quagga.initialized == undefined) {
        Quagga.onDetected(function(result) {
          if (detectionState.processingDetection) return;
          const code = result.codeResult.code;
          const error = result.codeResult.error;
          if (error !== undefined && error > detectionState.confidenceThreshold) return;
          detectionState.results.push({ code: code, error: error || 0 });
          if (detectionState.results.length > detectionState.maxResults) detectionState.results.shift();
          const bestMatch = getBestMatch();
          if (bestMatch && bestMatch !== detectionState.lastDetectedCode) {
            detectionState.processingDetection = true;
            detectionState.lastDetectedCode = bestMatch;
            scannerFrame.classList.add('detected');
            beep.play();
            Quagga.stop();
            isScanning = false;
            saveBarcode(bestMatch);
          }
        });
      }
      Quagga.init({
        inputStream: {
          name: "Live", type: "LiveStream",
          constraints: { width: { min: 640, ideal: 1280, max: 1920 }, height: { min: 480, ideal: 720, max: 1080 }, facingMode: "environment", aspectRatio: { min: 1, max: 2 } },
          target: document.querySelector('#interactive'),
          area: { top: "10%", right: "10%", left: "10%", bottom: "10%" }
        },
        decoder: {
          readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "code_93_reader", "upc_reader", "upc_e_reader", "codabar_reader"],
          multiple: false
        },
        locator: { halfSample: false, patchSize: 'large' },
        locate: true,
        frequency: 10
      }, function(err) {
        if (err) { alert('Error initializing camera. Please ensure camera permissions are granted.'); return; }
        Quagga.start();
        isScanning = true;
        updateUI();
      });
    }
  }

  Quagga.onProcessed(function(result) {
    if (result) {
      const ctx = Quagga.canvas.ctx.overlay, canvas = Quagga.canvas.dom.overlay;
      if (result.boxes) { ctx.clearRect(0, 0, parseInt(canvas.getAttribute("width")), parseInt(canvas.getAttribute("height"))); }
      if (result.box) { Quagga.ImageDebug.drawPath(result.box, {x:0,y:1}, ctx, {color:"#6366f1",lineWidth:2}); }
      if (result.codeResult && result.codeResult.code) { Quagga.ImageDebug.drawPath(result.line, {x:'x',y:'y'}, ctx, {color:'#10b981',lineWidth:3}); }
    }
  });

  function startScanning() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { alert('Camera access not supported in this browser.'); return; }
    scannerFrame.classList.remove('detected');
    resetDetectionState();
    load_quagga();
  }

  function stopScanning() { Quagga.stop(); isScanning = false; resetDetectionState(); updateUI(); }
  function updateUI() { startBtn.style.display = isScanning ? 'none' : 'inline-flex'; stopBtn.style.display = isScanning ? 'inline-flex' : 'none'; scanningIndicator.style.display = isScanning ? 'block' : 'none'; }

  function saveBarcode(barcode_data) {
    scanningIndicator.innerHTML = '<i class="bi bi-check-circle"></i> Detected: ' + barcode_data;
    $.ajax({
      url: '{% url "save_barcode_dockingstation" %}', timeout: 10000, method: 'POST',
      data: { barcode_data: barcode_data, csrfmiddlewaretoken: '{{ csrf_token }}' },
      success: function(response) { window.location.href = '{% url "dockingstation_form" barcode=0 %}'.replace('0', barcode_data); },
      error: function() { alert('Error processing barcode. Redirecting to form...'); window.location.href = '{% url "dockingstation_form" barcode=0 %}'.replace('0', barcode_data); }
    });
  }
  updateUI();
</script>
{% endblock %}
